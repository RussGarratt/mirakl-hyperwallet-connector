= Notifications

== Storing and filtering notifications

Hyperwallet API (as any other existing API) cannot guarantee the order of the notifications received for a specific item (seller, stakeholder, payment…), therefore, this could cause issues changing the KYC status of sellers that were already verified by Hyperwallet moving them back to be verified again or not properly updating the payments, causing inconsistencies in the info between Hyperwallet and Mirakl platforms.

To avoid such possible issues, the HMC includes a functionality to store all the notifications received and filter out the obsolete and duplicated notifications for a specific item, processing only the necessary notifications.

*+++Functionality behaviour+++*

As soon as a notification is received in the HMC, it will be stored in the database, except for two different cases where notifications will be skipped:

* Duplicated notification: the same notification already received and stored in the database
* Obsolete notification: a notification for the same item (a specific seller, stakeholder...), but created before the existing one already stored in the database.

image:image13.jpg[Diagram Description automatically generated,width=505,height=170]

The following information is stored in the database in the NotificationEntity table:

[width="100%",cols="24%,13%,63%",]
|===
|*Database field* |*Data type* |*Notes*
|Id |Long |Autogenerated ID
|webhookToken |String |Token of the notification
|objectToken |String |Token of the related item
|creationDate |Date |Creation date of the notification on HW
|receptionDate |Date |Date the notification was received in the HMC
|notificationType |Date |Type of the notification, containing one of the following possible values: USR, PMT, STK, TRM, UNK
|===

The notification type is not received in the Hyperwallet webhook, however, the three first characters of the token contain the type of the notification.

The possible values that will be stored in the database are:

* USR Sellers
* STK Stakeholders
* PMT Paymets (invoices)
* TRM Bank account
* UNK Unknown

UNK value will not be received in the webhook, however if the HMC receives an unknown notification type (not included in the recognised values USR, STK, PMT or TRM), this value will be stored to avoid any failure cause the notification type is not a “valid” one.

*+++Notifications querying and housekeeping+++*

Two different endpoints are available to query or to remove the notifications stored in the database.

To query the notifications currently stored in the database, an endpoint using the GET HTTP method is available under /webhooks/notifications path.

To avoid the database size increasing without any limit, an endpoint using the DELETE HTTP method is available under /webhooks/notifications path.

Both endpoints include two parameters (“from” and “to”) so that a range of dates are provided in order to query/remove the notifications received within such period.

Both parameters are mandatory to avoid problems removing notifications accidentally.

HMC has not created any job to remove the notifications, and the customer is responsible on triggering (manually or automatically) the mentioned endpoint to remove the notifications (if needed) based on their company policies.

Example of valid execution request for both querying and removing notifications:

____
curl --location --request GET 'http://localhost:8080/webhooks/notifications?from=2021-04-27T10:30:00.000-00:00&to=2023-04-27T10:30:00.000-00:00'

curl --location --request DELETE 'http://localhost:8080/webhooks/notifications?from=2021-04-27T10:30:00.000-00:00&to=2023-04-27T10:30:00.000-00:00'
____

== Notifications retry mechanism

In order to improve the reliability of the HMC, a mechanism has been implemented to retry the processing of the notifications received from Hyperwallet just in case it is not possible to upload the information in Mirakl for any reason.

The issue rarely happens, and it can be easily identified. This could not cause a severe problem with the payment notifications as the workaround would be as simple as updating the payment status in the Mirakl backoffice, however for the KYC notifications there is not a friendly solution and using an external tool to execute a request to one of the Mirakl API’s is needed.

To avoid these manual workarounds and automatically solve the inconsistences produced due to the failure update on Mirakl, the retry notifications mechanism can be enabled in the HMC.

Sensitive information is never stored in the database nor displayed in the logs, only the tokens are used to identify the notifications.

*+++Functionality behaviour+++*

The tokens of the notifications failing when trying to update information on Mirakl will be stored in the database, so that a periodical job retrieve such notifications from Hyperwallet and then try to update Mirakl again until they reach the maximum number of attempts allowed (configurable using an environment variable as explained below)

Following scenarios could happen when a received notification fails and then checks if it already exists in the failed notifications information:

* *Already existing notification* the notification is skipped as it is identical to the previous one.
* *Updated existing notification* the same notification with a creation date later than the existing one is received and then the previous one is removed from the database.
* *Outdated existing notification* the same notification with a creation date before the existing one is received and then the notification is skipped.

When a specific notification is retried and fails, reaching the maximum number of allowed attempts, such notification is removed from the database and an email will be sent to the operator.

*+++Retrying the notifications+++*

All the failed notifications stored in the database are retried periodically using a cronjob that will be executed every 15 minutes by default (configurable using an environment variable as explained below).

The job execution will check all failed notifications stored in the database trying to process each one again. If the notification is properly processed successfully updating the information on Mirakl, the notification will be removed from the database, otherwise, the number of retries will be increased for such notification unless it reaches the maximum number of attempts causing the notification won’t be retried anymore removing it from the database.

*+++Configuring the feature+++*

The retry mechanism can be configured using the following environment variables:


* *PAYPAL_HYPERWALLET_RETRY_NOTIFICATIONS* This variable can be set to “*_true”_* to enable the notifications retry mechanism, or *_“false”_* to deactivate it. Set to *_“true”_* by default.

* *PAYPAL_HYPERWALLET_MAX_AMOUNT_OF_NOTIFICATION_RETRIES* this variable determines the number of maximum attempts allowed for each notification. Set to *_“5”_* by default

* *PAYPAL_HYPERWALLET_RETRY_FAILED_NOTIFICATIONS_CRON_EXPRESSION* used to *configure the periodicity of the cron job*

*+++Database type+++*

[width="100%",cols="24%,18%,13%,45%",]
|===
|*Data* |*Database field* |*Data type* |*Notes*
|Notification token |notificationToken |String | Token of the specific notification
|Notification type |type |String | Payment, user or stakeholder update, etc…
|Target token |target |String | Token of the notification object
|Program token |programToken |String |
|Number of retries |retryCounter |Int |Current number of times the failed notification has been retried
|Creation date |creationDate |Date |Creation date of the notification on HW
|===

*+++Notify the failures+++*

In order to notify the operator about the failed notifications, an email will be sent every time a notification reaches its maximum number of attempts, including the following details:

____
_*Subject*: [HMC] Technical error occurred when processing the notification N_

_ +
*Body*: There was an error processing the notification ‘N’ and the operation could not be completed. The maximum number of attempts ‘M’ has been reached, therefore it will not try to re-process the notification anymore. Please check the logs for further information_
____

Logs also include traces for the following cases

* A failed notification if going to be stored and retried.
* An outdated notification has been received and will be skipped.
* An updated notification has been received, and the previous one will be removed.
* A notification has exceeded the maximum number of allowed attempts.
